<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Kiejt√©s gyakorl√≥ ‚Äî B√∂ng√©sz≈ës STT (hu)</title>
<style>
/* Egyszer≈±, tiszta st√≠lus; igyekeztem a kor√°bbi diz√°jnt k√∂vetni */
*{box-sizing:border-box}
body{font-family:Segoe UI,system-ui,Arial;margin:0;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;color:#222}
.container{width:100%;max-width:900px;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);overflow:hidden}
header{background:linear-gradient(90deg,#ff7a18,#af0d1f);color:#fff;padding:22px;text-align:center}
header h1{margin:0;font-size:1.6rem}
.body{padding:20px}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
select,button,input{font-size:1rem;padding:10px;border-radius:8px;border:1px solid #ccc}
button{cursor:pointer;background:#1976d2;color:#fff;border:none}
.controls{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
.status{margin-top:12px;padding:10px;border-radius:8px;background:#f1f3f5;color:#333}
.feedback{margin-top:12px;padding:12px;border-radius:8px}
.good{background:#e8f5e9;color:#2e7d32;border:1px solid #c8e6c9}
.warn{background:#fff8e1;color:#856404;border:1px solid #ffecb3}
.bad{background:#ffebee;color:#c62828;border:1px solid #ffcdd2}
.small{font-size:.9rem;color:#555}
.progress-bar{height:10px;background:#eee;border-radius:6px;overflow:hidden;margin-top:8px}
.progress-fill{height:100%;width:0;background:linear-gradient(90deg,#ff7043,#66bb6a);transition:width .4s}
</style>
</head>
<body>
  <div class="container" role="application" aria-label="Kiejt√©s gyakorl√≥">
    <header>
      <h1>Kiejt√©s Gyakorl√≥</h1>
      <div class="small">B√∂ng√©sz≈ës STT (ha el√©rhet≈ë): magyar (hu-HU). Firefox fallback audio-elemz√©ssel.</div>
    </header>

    <div class="body">
      <div class="row">
        <label for="wordCount">Szavak sz√°ma:</label>
        <select id="wordCount"></select>

        <button id="startBtn">üöÄ Start</button>
        <button id="nextBtn">‚û°Ô∏è K√∂vetkez≈ë sz√≥</button>
        <button id="listenBtn">üîä Hallgasd</button>
      </div>

      <div id="progress" class="status" style="display:none;margin-top:12px"></div>

      <div id="wordCard" style="margin-top:16px;display:none">
        <div style="font-size:2.4rem;color:#d32f2f;font-weight:700" id="targetWord">‚Äî</div>
        <div style="color:#666;margin-top:6px" id="targetInfo">‚Äî</div>

        <div class="controls">
          <button id="recordBtn">üé§ Start Recording</button>
          <button id="stopBtn" disabled>‚èπ Stop</button>
        </div>

        <div id="recordingStatus" class="status" style="display:block;margin-top:12px">Ready</div>

        <div id="feedback" class="feedback" style="display:none;margin-top:12px"></div>

        <div class="progress-bar" style="display:none" id="scoreBar">
          <div class="progress-fill" id="scoreFill"></div>
        </div>
      </div>

      <div style="margin-top:18px;color:#666;font-size:.95rem">
        <p><strong>Megjegyz√©s:</strong> A mikrofon enged√©lyez√©se sz√ºks√©ges. Chrome/Edge √°ltal√°ban j√≥l t√°mogatja a magyar STT-t (ha a b√∂ng√©sz≈ëd t√°mogatja). Firefoxban a fallback audio-√∂sszehasonl√≠t√°st haszn√°ljuk.</p>
      </div>
    </div>
  </div>

<script>
/* ---------- SZ√ìT√ÅR (kezd√©snek) ---------- */
const fullWordDictionary = [
  {hungarian:"k√∂sz√∂n√∂m", meaning:"Ë∞¢Ë∞¢"},
  {hungarian:"alma", meaning:"ËãπÊûú"},
  {hungarian:"edz√©s", meaning:"sport"},
  {hungarian:"iskola", meaning:"xu√©xi√†o"},
  {hungarian:"szia", meaning:"n«ê h«éo"},
  {hungarian:"v√≠z", meaning:"Ê∞¥"},
  {hungarian:"tanul√°s", meaning:"Â≠¶‰π†"},
  {hungarian:"munka", meaning:"Â∑•‰Ωú"},
  {hungarian:"bar√°t", meaning:"ÊúãÂèã"},
  {hungarian:"bolt", meaning:"Â∫óÈì∫"}
];
/* b≈ëv√≠thet≈ë k√©s≈ëbb */

/* ---------- DOM ---------- */
const wordCountSelect = document.getElementById('wordCount');
const startBtn = document.getElementById('startBtn');
const nextBtn = document.getElementById('nextBtn');
const listenBtn = document.getElementById('listenBtn');
const recordBtn = document.getElementById('recordBtn');
const stopBtn = document.getElementById('stopBtn');
const recordingStatus = document.getElementById('recordingStatus');
const targetWordEl = document.getElementById('targetWord');
const targetInfoEl = document.getElementById('targetInfo');
const wordCard = document.getElementById('wordCard');
const progressEl = document.getElementById('progress');
const feedbackEl = document.getElementById('feedback');
const scoreBar = document.getElementById('scoreBar');
const scoreFill = document.getElementById('scoreFill');

let selectedWords = [], currentIndex = 0;
let mediaRecorder = null, audioChunks = [], isRecording = false, audioContext = null;
let lastTranscript = "";
let recognizer = null;
const isFirefox = typeof InstallTrigger !== 'undefined';
const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition || null;
let recogSupported = false;

/* ---------- Dinamikus sz√°mlista 1..min(50, teljes) ---------- */
(function populateWordCount(){
  const max = Math.min(50, fullWordDictionary.length);
  wordCountSelect.innerHTML = '';
  for(let i=1;i<=max;i++){
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = i;
    wordCountSelect.appendChild(opt);
  }
})();

/* ---------- SpeechRecognition init (Chromium alap√∫) ---------- */
if(SpeechRec){
  try {
    recognizer = new SpeechRec();
    recognizer.interimResults = false;
    recognizer.maxAlternatives = 1;
    recognizer.lang = 'hu-HU';
    recogSupported = true;
  } catch(e){
    recognizer = null;
    recogSupported = false;
  }
}

/* ---------- Seg√©df√ºggv√©nyek ---------- */
// Levenshtein-t√°vols√°g
function levenshtein(a,b){
  if(!a) return b.length;
  if(!b) return a.length;
  a = a.split('');
  b = b.split('');
  const m = a.length, n = b.length;
  const dp = Array.from({length:m+1},()=>Array(n+1).fill(0));
  for(let i=0;i<=m;i++) dp[i][0]=i;
  for(let j=0;j<=n;j++) dp[0][j]=j;
  for(let i=1;i<=m;i++){
    for(let j=1;j<=n;j++){
      const cost = a[i-1]===b[j-1]?0:1;
      dp[i][j] = Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
    }
  }
  return dp[m][n];
}
// similarity 0..1 based on Levenshtein
function similarityScore(a,b){
  if(!a && !b) return 1;
  if(!a || !b) return 0;
  a=a.toLowerCase().trim();
  b=b.toLowerCase().trim();
  const dist = levenshtein(a,b);
  const maxlen = Math.max(a.length,b.length);
  if(maxlen===0) return 1;
  const sim = Math.max(0, 1 - dist / maxlen);
  return sim;
}

/* ---------- Audio envelope functions (fallback) ---------- */
function estimateSyllableCount(word){
  const v = word.toLowerCase().match(/[aeiou√°√©√≠√≥√∂≈ë√∫√º≈±y]+/g);
  return v ? Math.max(1, v.length) : 1;
}
function makeReferenceEnvelope(word, bins=28){
  const syllables = estimateSyllableCount(word);
  const env = new Array(bins).fill(0);
  for(let s=0;s<syllables;s++){
    const center = Math.floor((s+0.5)*bins/syllables);
    const width = Math.max(1, Math.floor(bins/(syllables*1.6)));
    for(let i=0;i<bins;i++){
      const d = Math.abs(i-center);
      env[i] += Math.max(0, (1 - (d/width)));
    }
  }
  const maxv = Math.max(...env);
  if(maxv>0) for(let i=0;i<env.length;i++) env[i] = env[i]/maxv;
  return env;
}
async function getAudioEnvelopeFromBlob(blob, bins=28){
  if(!audioContext) audioContext = new (window.AudioContext||window.webkitAudioContext)();
  const arrayBuffer = await blob.arrayBuffer();
  const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
  const channelData = audioBuffer.getChannelData(0);
  const len = channelData.length;
  const binSize = Math.max(1, Math.floor(len/bins));
  const env = new Array(bins).fill(0);
  for(let b=0;b<bins;b++){
    const start = b*binSize;
    const end = (b===bins-1)?len:(start+binSize);
    let sum = 0;
    for(let i=start;i<end;i++){
      const v = channelData[i];
      sum += v*v;
    }
    const rms = Math.sqrt(sum/Math.max(1,end-start));
    env[b] = rms;
  }
  const maxv = Math.max(...env);
  if(maxv>0) for(let i=0;i<env.length;i++) env[i] = env[i]/maxv;
  return env;
}
function cosineSimilarity(a,b){
  if(!a||!b||a.length!==b.length) return 0;
  let dot=0, na=0, nb=0;
  for(let i=0;i<a.length;i++){ dot += a[i]*b[i]; na += a[i]*a[i]; nb += b[i]*b[i]; }
  if(na===0||nb===0) return 0;
  return dot / (Math.sqrt(na)*Math.sqrt(nb));
}

/* ---------- UI helperok ---------- */
function showFeedback(type,title,detail,scorePct=null){
  feedbackEl.style.display='block';
  feedbackEl.className='feedback';
  if(type==='good') feedbackEl.classList.add('good');
  else if(type==='warn') feedbackEl.classList.add('warn');
  else feedbackEl.classList.add('bad');
  let html = `<div style="font-weight:bold">${title}</div><div style="margin-top:8px;color:#333">${detail}</div>`;
  if(scorePct!==null){
    scoreBar.style.display='block';
    scoreFill.style.width = `${scorePct}%`;
    html += `<div style="margin-top:8px">Egyez√©s: <strong>${scorePct}%</strong></div>`;
  } else {
    scoreBar.style.display='none';
    scoreFill.style.width = `0%`;
  }
  feedbackEl.innerHTML = html;
}

/* ---------- Alap folyamatok ---------- */
function pickRandomWords(n){
  const arr = [...fullWordDictionary].sort(()=>0.5 - Math.random());
  return arr.slice(0, Math.min(n, arr.length));
}
function updateProgress(){
  progressEl.style.display='block';
  progressEl.textContent = `${currentIndex+1}/${selectedWords.length}`;
}
function displayCurrent(){
  if(!selectedWords.length) return;
  const w = selectedWords[currentIndex];
  targetWordEl.textContent = w.hungarian;
  targetInfoEl.textContent = `Meaning: ${w.meaning || '-'}`;
  recordingStatus.textContent = 'Kattints Start Recording, mondd be a sz√≥t, majd Stop.';
  feedbackEl.style.display='none';
  scoreBar.style.display='none';
  scoreFill.style.width = '0%';
  lastTranscript = "";
  audioChunks = [];
}

/* ---------- RECORDING & RECOGNITION ---------- */
async function startRecording(){
  try{
    recordingStatus.textContent = 'üîÑ Mikrofon enged√©lyez√©se...';
    const stream = await navigator.mediaDevices.getUserMedia({ audio: { sampleRate:16000, channelCount:1, echoCancellation:true, noiseSuppression:true } });
    audioChunks = [];
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => { if(e.data && e.data.size>0) audioChunks.push(e.data); };
    mediaRecorder.onstop = async () => {
      // stop event: a blob m√°r rendelkez√©sre √°ll
      recordingStatus.textContent = '‚úÖ Mentve ‚Äî elemz√©s indul...';
      try{ stream.getTracks().forEach(t=>t.stop()); }catch(e){}
      await new Promise(r=>setTimeout(r,200)); // kis k√©sleltet√©s
      await analyzeRecordingFlow();
    };
    mediaRecorder.start();
    isRecording = true;
    recordBtn.disabled = true;
    stopBtn.disabled = false;
    recordingStatus.textContent = 'üî¥ Felv√©tel... Besz√©lj!';
    // ha van recognizer √©s nem Firefox, ind√≠tjuk p√°rhuzamosan
    if(recogSupported && recognizer && !isFirefox){
      lastTranscript = "";
      try{
        recognizer.onresult = function(ev){
          lastTranscript = ev.results[0][0].transcript;
          recordingStatus.textContent = `üó£ Felismerve: "${lastTranscript}"`;
        };
        recognizer.onerror = function(ev){ console.warn('Recognizer error', ev); };
        recognizer.start();
      }catch(e){ console.warn('recognizer start failed', e); }
    }
  }catch(err){
    console.error('Recording error', err);
    recordingStatus.textContent = '‚ùå Mikrofon hiba vagy letiltva.';
    showFeedback('bad','Mikrofon hiba','Enged√©lyezd a mikrofont √©s pr√≥b√°ld √∫jra.');
  }
}

function stopRecording(){
  if(!mediaRecorder) return;
  if(isRecording && mediaRecorder.state !== 'inactive'){
    try{ mediaRecorder.stop(); }catch(e){}
    isRecording = false;
    recordBtn.disabled = false;
    stopBtn.disabled = true;
    // recognizer stop
    if(recogSupported && recognizer){
      try{ recognizer.stop(); }catch(e){}
    }
  }
}

/* ---------- ANAL√çZIS ---------- */
async function analyzeRecordingFlow(){
  feedbackEl.style.display='none';
  // STT √∫tvonal (Chromium + recognizer)
  if(recogSupported && lastTranscript && !isFirefox){
    const target = selectedWords[currentIndex].hungarian.toLowerCase();
    const spoken = lastTranscript.toLowerCase().trim();
    const sim = similarityScore(spoken, target);
    const pct = Math.round(sim * 100);
    if(pct === 0){
      showFeedback('bad','Teljesen elt√©r≈ë','Felismerve: "'+spoken+'"<br>Elv√°rt sz√≥: "'+target+'"',0);
    } else if(pct >= 0.9) {
      showFeedback('good','T√∂k√©letes','Felismerve: "'+spoken+'"',pct);
    } else if(pct >= 0.6){
      showFeedback('good','J√≥','Felismerve: "'+spoken+'"',pct);
    } else {
      showFeedback('warn','Pr√≥b√°ld √∫jra','Felismerve: "'+spoken+'"',pct);
    }
    recordingStatus.textContent = '‚úÖ Elemz√©s k√©sz...';
    return;
  }

  // Fallback: audio-envelope √∫t (Firefox vagy nincs transcript)
  if(!audioChunks || audioChunks.length === 0){
    recordingStatus.textContent = '‚ö† Nem tal√°lhat√≥ felv√©tel. K√©rlek pr√≥b√°ld √∫jra.';
    showFeedback('bad','Nincs felv√©tel','K√©rlek r√∂gz√≠tsd √∫jra a sz√≥t.');
    return;
  }

  const blob = new Blob(audioChunks, { type: audioChunks[0].type || 'audio/webm' });
  // Hallgassuk le opcion√°lisan (ha szeretn√©d): const url = URL.createObjectURL(blob);

  // J√°tssza le a TTS referenciahangot (id≈ëz√≠t√©s miatt)
  const target = selectedWords[currentIndex].hungarian;
  recordingStatus.textContent = '‚ñ∂ Lej√°tsz√°s (referencia) √©s feldolgoz√°s...';
  await playTTS(target);

  // envelope √∂sszehasonl√≠t√°s
  const bins = 28;
  const refEnv = makeReferenceEnvelope(target, bins);
  let userEnv;
  try {
    userEnv = await getAudioEnvelopeFromBlob(blob, bins);
  } catch(e){
    console.error('Audio decode hiba', e);
    recordingStatus.textContent = '‚ùå Nem siker√ºlt feldolgozni a felv√©telt.';
    showFeedback('bad','Feldolgoz√°si hiba','A felv√©tel dek√≥dol√°sa sikertelen.');
    return;
  }

  // besz√©d/nincs besz√©d detekt√°l√°s
  const avgEnergy = userEnv.reduce((a,b)=>a+b,0)/userEnv.length;
  const maxEnergy = Math.max(...userEnv);
  if(avgEnergy < 0.008 || maxEnergy < 0.015){
    recordingStatus.textContent = '‚ö† Nincs besz√©d √©rz√©kelve';
    showFeedback('bad','Nincs besz√©d','Suttog√°s vagy zaj miatt nem √©szlelt√ºnk besz√©det.');
    return;
  }

  const sim = cosineSimilarity(refEnv, userEnv);
  let pct = Math.round(sim * 100);
  // ha nagyon kicsi hasonl√≥s√°g => val√≥di 0%
  if(pct < 20) pct = 0;

  if(pct === 0){
    showFeedback('bad','Teljesen elt√©r≈ë','A felv√©tel akusztikailag nem hasonl√≠t a referenci√°hoz.',0);
  } else if(pct >= 85){
    showFeedback('good','Kiv√°l√≥ kiejt√©s','Akusztikus hasonl√≥s√°g magas',pct);
  } else if(pct >= 60){
    showFeedback('good','J√≥ kiejt√©s','Akusztikus hasonl√≥s√°g k√∂zepes',pct);
  } else {
    showFeedback('warn','Pr√≥b√°ld √∫jra','Akusztikus hasonl√≥s√°g alacsony',pct);
  }

  recordingStatus.textContent = '‚úÖ Elemz√©s k√©sz (akusztikus)';
}

/* ---------- TTS ---------- */
function playTTS(text){
  return new Promise(resolve=>{
    if(!('speechSynthesis' in window)){ setTimeout(resolve, Math.max(500, text.length*60)); return; }
    const ut = new SpeechSynthesisUtterance(text);
    ut.lang = 'hu-HU';
    ut.rate = 0.95;
    ut.onend = ()=> resolve();
    ut.onerror = ()=> resolve();
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(ut);
  });
}

/* ---------- Esem√©nyek ---------- */
startBtn.addEventListener('click', ()=>{
  const n = parseInt(wordCountSelect.value,10) || 1;
  const total = fullWordDictionary.length;
  const pickCount = Math.min(n, total);
  selectedWords = pickRandomWords(pickCount);
  currentIndex = 0;
  wordCard.style.display = 'block';
  progressEl.style.display = 'block';
  updateProgress();
  displayCurrent();
});

nextBtn.addEventListener('click', ()=>{
  if(!selectedWords.length) return;
  currentIndex = (currentIndex + 1) % selectedWords.length;
  updateProgress();
  displayCurrent();
});

listenBtn.addEventListener('click', ()=>{
  const w = selectedWords[currentIndex];
  if(!w) return;
  playTTS(w.hungarian);
});

recordBtn.addEventListener('click', startRecording);
stopBtn.addEventListener('click', stopRecording);

/* gyorsbillenty≈±: space a r√∂gz√≠t√©sre (ha gombon a f√≥kusz) */
document.addEventListener('keydown', (e)=>{
  if(e.key === ' ' && document.activeElement === recordBtn){
    e.preventDefault();
    if(!isRecording) startRecording(); else stopRecording();
  }
});

/* ---------- Init st√°tusz ---------- */
(function init(){
  recordingStatus.textContent = recogSupported && !isFirefox ? 'SpeechRecognition el√©rhet≈ë (hu-HU).' : (isFirefox ? 'Firefox: audio-fallback haszn√°lva.' : 'STT nem el√©rhet≈ë; audio-fallback.');
})();
</script>
</body>
</html>



