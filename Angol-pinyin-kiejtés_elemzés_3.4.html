<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title></title>
<style>
  *{box-sizing:border-box}
  body{font-family:Segoe UI,system-ui,Arial;margin:0;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;color:#222}
  .card{width:100%;max-width:900px;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);overflow:hidden}
  header{background:linear-gradient(90deg,#ff7a18,#af0d1f);color:#fff;padding:22px;text-align:center}
  header h1{margin:0;font-size:1.6rem}
  .body{padding:20px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  select,button,input{font-size:1rem;padding:10px;border-radius:8px;border:1px solid #ccc}
  button{cursor:pointer;background:#1976d2;color:#fff;border:none}
  .controls{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
  .status{margin-top:12px;padding:10px;border-radius:8px;background:#f1f3f5;color:#333}
  .feedback{margin-top:12px;padding:12px;border-radius:8px;background:#fff}
  .good{background:#e8f5e9;color:#2e7d32;border:1px solid #c8e6c9}
  .warn{background:#fff8e1;color:#856404;border:1px solid #ffecb3}
  .bad{background:#ffebee;color:#c62828;border:1px solid #ffcdd2}
  .small{font-size:.9rem;color:#555}
</style>
</head>
<body>
  <div class="card" role="application" aria-label="Kiejt√©s gyakorl√≥" <br><strong>Pronunciation Practice</strong>
    <header>
      <h1>Kiejt√©s Gyakorl√≥ <br><b> Pronunciation Practice</b></h1>
      <div class="small">Chrome/Edge: STT (ha el√©rhet≈ë). Firefox: audio-alap√∫ √∂sszehasonl√≠t√°s.</div>
    </header>

    <div class="body">
      <div class="row">
        <label for="wordCount">Szavak sz√°ma / Number of words:</label>
        <select id="wordCount">
          <option value="5">5</option>
          <option value="7" selected>7</option>
          <option value="10">10</option>
          <option value="0">All</option>
        </select>

        <button id="startBtn">üöÄ Start</button>
        <button id="nextBtn">‚û°Ô∏è Next</button>
        <button id="listenBtn">üîä Play (TTS)</button>
      </div>

      <div id="progress" class="status" style="display:none;margin-top:12px"></div>

      <div id="wordCard" style="margin-top:16px;display:none">
        <div style="font-size:2rem;color:#d32f2f;font-weight:700" id="targetWord">‚Äî</div>
        <div style="color:#666;margin-top:6px" id="targetInfo">‚Äî</div>

        <div class="controls" style="margin-top:12px">
          <button id="recordBtn">üé§ Start Recording</button>
          <button id="stopBtn" disabled>‚èπ Stop</button>
          <button id="analyzeBtn" disabled>üîç Analyze</button>
        </div>

        <div id="recordingStatus" class="status" style="display:block;margin-top:12px">Ready</div>

        <div id="feedbackArea" class="feedback" aria-live="polite" style="display:none;margin-top:12px"></div>
      </div>

      <div style="margin-top:18px;color:#666;font-size:.95rem">
        <p><strong>Megjegyz√©s / Note:</strong><br> <small>Enged√©lyezd a mikrofont. Chrome/Edge eset√©n, ha el√©rhet≈ë, a b√∂ng√©sz≈ë besz√©dfelismer√©s√©t haszn√°ljuk (jobb precizit√°s sz√≥-egyez√©shez). 
         Firefoxban vagy ha nincs STT, akkor az audio mint√°zat alapj√°n adunk visszajelz√©st (zajk√ºsz√∂b be√©p√≠tve).</small><br>
       <strong>Enable your microphone. <br>In Chrome/Edge browsers, if available, the browser will use its speech recognition feature (for better word recognition).<br> In Firefox browsers, or if STT is not available, we will provide feedback based on the audio pattern (built-in noise threshold).</strong></p>
      </div>
    </div>
  </div>

<script>
/* ---------- Sz√≥t√°r ---------- */
const fullWordDictionary = [
  {english:"thank you", pinyin:"thank you", meaning:"Ë∞¢Ë∞¢"},
  {english:"good day", pinyin:"good day", meaning:"‰Ω†Â•Ω"},
  {english:"I love you", pinyin:"I love you", meaning:"ÊàëÁà±‰Ω†"},
  {english:"hello", pinyin:"hello", meaning:"‰Ω†Â•Ω"},
  {english:"water", pinyin:"water", meaning:"Ê∞¥"},
  {english:"mother", pinyin:"mother", meaning:"Â¶àÂ¶à"},
  {english:"friend", pinyin:"friend", meaning:"ÊúãÂèã"},
  {english:"breakfast", pinyin:"breakfast", meaning:"Êó©È§ê"},
  {english:"lunch", pinyin:"lunch", meaning:"ÂçàÈ§ê"},
  {english:"dinner", pinyin:"dinner", meaning:"ÊôöÈ§ê"},
  {english:"soup", pinyin:"soup", meaning:"Ê±§"},
  {english:"salad", pinyin:"salad", meaning:"Ê≤ôÊãâ"}
];

/* ---------- DOM ---------- */
const startBtn = document.getElementById('startBtn');
const nextBtn = document.getElementById('nextBtn');
const listenBtn = document.getElementById('listenBtn');
const recordBtn = document.getElementById('recordBtn');
const stopBtn = document.getElementById('stopBtn');
const analyzeBtn = document.getElementById('analyzeBtn');
const recordingStatus = document.getElementById('recordingStatus');
const targetWordEl = document.getElementById('targetWord');
const targetInfoEl = document.getElementById('targetInfo');
const wordCard = document.getElementById('wordCard');
const progressEl = document.getElementById('progress');
const feedbackArea = document.getElementById('feedbackArea');
const wordCountSelect = document.getElementById('wordCount');

let selectedWords = [], currentIndex = 0;

/* ---------- Capabilities ---------- */
const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition || null;
let recognizer = null;
let recogSupported = false;
if (SpeechRec) {
  try {
    recognizer = new SpeechRec();
    recognizer.interimResults = false;
    recognizer.maxAlternatives = 1;
    recognizer.lang = 'en-US';
    recogSupported = true;
  } catch(e) {
    recognizer = null;
    recogSupported = false;
  }
}
const isFirefox = typeof InstallTrigger !== 'undefined';

/* ---------- Recording state ---------- */
let mediaRecorder = null;
let audioChunks = [];
let isRecording = false;
let audioContext = null;
let lastTranscript = "";

/* ---------- Helpers ---------- */
function pickRandomWords(n) {
  if (n === 0 || n >= fullWordDictionary.length) return [...fullWordDictionary];
  const shuffled = [...fullWordDictionary].sort(()=>0.5-Math.random());
  return shuffled.slice(0, n);
}
function updateProgress() {
  progressEl.style.display = 'block';
  progressEl.textContent = `${currentIndex+1}/${selectedWords.length}`;
}
function showFeedback(type, title, detail) {
  feedbackArea.style.display = 'block';
  feedbackArea.className = 'feedback';
  if (type === 'good') feedbackArea.classList.add('good');
  else if (type === 'warn') feedbackArea.classList.add('warn');
  else feedbackArea.classList.add('bad');
  feedbackArea.innerHTML = `<div style="font-weight:bold">${title}</div><div style="margin-top:8px;color:#333">${detail}</div>`;
}
function clearFeedback(){
  feedbackArea.style.display = 'none';
  feedbackArea.className = 'feedback';
  feedbackArea.innerHTML = '';
}

/* ---------- Audio envelope utilities (for Firefox path) ---------- */
function estimateSyllableCount(word){
  const v = word.toLowerCase().match(/[aeiouy]+/g);
  return v ? Math.max(1, v.length) : 1;
}
function makeReferenceEnvelope(word, bins=28){
  const syllables = estimateSyllableCount(word);
  const env = new Array(bins).fill(0);
  for (let s=0;s<syllables;s++){
    const center = Math.floor((s+0.5)*bins/syllables);
    const width = Math.max(1, Math.floor(bins/(syllables*1.6)));
    for (let i=0;i<bins;i++){
      const d = Math.abs(i-center);
      env[i] += Math.max(0, (1 - (d/width)));
    }
  }
  const maxv = Math.max(...env);
  if (maxv>0) for (let i=0;i<env.length;i++) env[i] = env[i]/maxv;
  return env;
}
async function getAudioEnvelopeFromBlob(blob, bins=28){
  if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const arrayBuffer = await blob.arrayBuffer();
  const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
  const channelData = audioBuffer.getChannelData(0);
  const len = channelData.length;
  const binSize = Math.max(1, Math.floor(len / bins));
  const env = new Array(bins).fill(0);
  for (let b=0;b<bins;b++){
    const start = b*binSize;
    const end = (b===bins-1) ? len : (start + binSize);
    let sum = 0;
    for (let i=start;i<end;i++){
      const v = channelData[i];
      sum += v*v;
    }
    const rms = Math.sqrt(sum / Math.max(1, end-start));
    env[b] = rms;
  }
  const maxv = Math.max(...env);
  if (maxv>0) for (let i=0;i<env.length;i++) env[i] = env[i] / maxv;
  return env;
}
function cosineSimilarity(a,b){
  if (!a || !b || a.length !== b.length) return 0;
  let dot=0, na=0, nb=0;
  for (let i=0;i<a.length;i++){ dot += a[i]*b[i]; na += a[i]*a[i]; nb += b[i]*b[i]; }
  if (na===0 || nb===0) return 0;
  return dot / (Math.sqrt(na)*Math.sqrt(nb));
}

/* ---------- Phonetic/simple textual compare (Chromium STT path) ---------- */
const phoneticDictionary = {
  "hello":["helo","helou","halo","hellou","ellow"],
  "thank you":["tenk ju","sank ju","thank yu","tenk you","sank you"],
  "good day":["gud dei","gud day","good dei","gud dey"],
  "i love you":["ai lav ju","ay lov you","i lav yu"],
  "water":["voter","vater","woter"],
  "mother":["mader","mather","moter"],
  "friend":["frend","frind","freind"],
  "breakfast":["brekfast"],
  "lunch":["lancs","lanch"],
  "dinner":["diner","dine"]
};
function simpleSimilarity(a,b){
  if (!a||!b) return 0;
  a=a.toLowerCase().trim(); b=b.toLowerCase().trim();
  if (a===b) return 1;
  const variants = phoneticDictionary[b]||[];
  if (variants.includes(a)) return 0.85;
  const minLen = Math.min(a.length,b.length);
  let matches=0;
  for (let i=0;i<minLen;i++) if (a[i]===b[i]) matches++;
  return matches / Math.max(a.length,b.length);
}
function phoneticCompare(spoken,target){
  const s = simpleSimilarity(spoken,target);
  if (s>=0.9) return {match:true,score:95,type:'perfect'};
  if (s>=0.75) return {match:true,score:80,type:'good'};
  if (s>=0.5) return {match:true,score:60,type:'partial'};
  if (/[√°√©√≠√≥√∂≈ë√∫√º≈±]|sz|zs|cs|gy|ty|ny|ly/.test(spoken)) return {match:false,score:15,type:'hungarian'};
  return {match:false,score:30,type:'no_match'};
}

/* ---------- Flow: recording ---------- */
async function startRecording(){
  try{
    recordingStatus.textContent = 'üîÑ Accessing microphone...';
    const stream = await navigator.mediaDevices.getUserMedia({ audio: { sampleRate:16000, channelCount:1, echoCancellation:true, noiseSuppression:true } });
    audioChunks = [];
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => { if (e.data && e.data.size>0) audioChunks.push(e.data); };
    mediaRecorder.onstop = () => {
      recordingStatus.textContent = '‚úÖ Recording saved (ready to analyze)';
      analyzeBtn.disabled = false;
      try{ stream.getTracks().forEach(t=>t.stop()); }catch(e){}
    };
    mediaRecorder.start();
    isRecording = true;
    recordBtn.disabled = true;
    stopBtn.disabled = false;
    analyzeBtn.disabled = true;
    recordingStatus.textContent = 'üî¥ Recording... Speak now!';
    lastTranscript = "";

    // if recognizer available, start it in parallel to capture transcript
    if (recogSupported && recognizer) {
      try {
        recognizer.onresult = function(ev){
          lastTranscript = ev.results[0][0].transcript;
          recordingStatus.textContent = `üó£ Recognized: "${lastTranscript}"`;
        };
        recognizer.onerror = function(ev){ console.warn('Recognizer error', ev); };
        recognizer.start();
      } catch(e) {
        console.warn('Recognizer start failed', e);
      }
    }
  } catch(err){
    console.error('Recording error', err);
    recordingStatus.textContent = '‚ùå Microphone access denied or error';
    showFeedback('bad', 'Microphone error', 'Please allow microphone access and retry.');
  }
}
function stopRecording(){
  if (!mediaRecorder) return;
  if (isRecording && mediaRecorder.state !== 'inactive'){
    recordingStatus.textContent = '‚èπ Stopping...';
    isRecording = false;
    recordBtn.disabled = false;
    stopBtn.disabled = true;
    try{ if (recognizer) recognizer.stop(); }catch(e){}

    // ‚úÖ Az elemz√©st akkor ind√≠tjuk, amikor a felv√©tel t√©nylegesen befejez≈ëdik:
    mediaRecorder.onstop = async () => {
      recordingStatus.textContent = '‚úÖ Recording saved. Starting analysis...';
      analyzeBtn.disabled = true;

      // egy kis k√©sleltet√©s, hogy a b√∂ng√©sz≈ë lez√°rja a blobot
      await new Promise(res => setTimeout(res, 400));

      // most m√°r biztons√°gosan el√©rhet≈ë az audioChunks tartalma
      await analyzeRecordingFlow();
    };

    mediaRecorder.stop();
  }
}


/* ---------- Analyze: STT preferred, else audio-envelope ---------- */
async function analyzeRecording(){
  recordingStatus.textContent = 'üîç Analyzing...';
  clearFeedback();
  analyzeBtn.disabled = true;

  // If STT recognized something (Chromium path), use textual phonetic compare
  if (recogSupported && lastTranscript && lastTranscript.trim().length>0) {
    const currentWord = selectedWords[currentIndex].english.toLowerCase();
    const spoken = lastTranscript.toLowerCase().trim();
    const res = phoneticCompare(spoken, currentWord);
    if (res.type === 'hungarian') {
      showFeedback('bad', 'Please speak English', `You said: "${spoken}" ‚Äî Target: "${currentWord}"`);
    } else if (res.type === 'perfect') {
      showFeedback('good', 'Perfect!', `You said: "${spoken}" ‚Äî Target: "${currentWord}"`);
    } else if (res.match) {
      showFeedback('good', 'Good pronunciation', `You said: "${spoken}" ‚Äî Target: "${currentWord}" (Score: ${res.score}%)`);
    } else {
      showFeedback('warn', 'Different word', `You said: "${spoken}" ‚Äî Target: "${currentWord}" (Score: ${res.score}%)`);
    }
    recordingStatus.textContent = '‚úÖ Analysis complete (STT)';
    return;
  }

  // ELSE: audio-based (Firefox or no transcript)
  if (!audioChunks || audioChunks.length===0) {
    recordingStatus.textContent = '‚ö† No recording found. Please record first.';
    showFeedback('bad','No input','No recorded audio found ‚Äî please record your voice.');
    analyzeBtn.disabled = false;
    return;
  }

  // decode and compute envelope
  const currentWord = selectedWords[currentIndex].english;
  recordingStatus.textContent = '‚ñ∂ Playing reference (TTS) for timing...';
  await playTTS(currentWord);
  recordingStatus.textContent = '‚è± Reference played ‚Äî processing audio...';

  const bins = 28;
  const refEnv = makeReferenceEnvelope(currentWord, bins);
  const blob = new Blob(audioChunks, { type: audioChunks[0].type || 'audio/webm' });
  const userEnv = await getAudioEnvelopeFromBlob(blob, bins);

  const avgEnergy = userEnv.reduce((a,b)=>a+b,0)/userEnv.length;
  const maxEnergy = Math.max(...userEnv);

  // Silence/no-speech detection thresholds (tuned conservatively)
  if (avgEnergy < 0.008 || maxEnergy < 0.015) {
    recordingStatus.textContent = '‚ö† No speech detected';
    showFeedback('bad', 'No speech detected', 'Please speak louder or move closer to the microphone.');
    analyzeBtn.disabled = false;
    return;
  }

  const sim = cosineSimilarity(refEnv, userEnv);
  const pct = Math.round(sim * 100);

  // Interpret percentage to friendly text (no numeric display required, but we include short text)
  if (pct >= 85) {
    showFeedback('good', 'Excellent pronunciation', `Detected acoustic match ‚Äî high similarity.`);
  } else if (pct >= 60) {
    showFeedback('good', 'Good pronunciation', `Detected moderate acoustic similarity.`);
  } else {
    showFeedback('warn', 'Try again', `Acoustic similarity is low ‚Äî try to match the reference more closely.`);
  }
  recordingStatus.textContent = '‚úÖ Analysis complete (audio)';
  analyzeBtn.disabled = false;
}

/* ---------- TTS helper ---------- */
function playTTS(text) {
  return new Promise(resolve=>{
    if (!('speechSynthesis' in window)) { setTimeout(resolve, Math.max(500, text.length*60)); return; }
    const ut = new SpeechSynthesisUtterance(text);
    ut.lang = 'en-US';
    ut.rate = 0.95;
    ut.onend = ()=> resolve();
    ut.onerror = ()=> resolve();
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(ut);
  });
}

/* ---------- UI wiring ---------- */
startBtn.addEventListener('click', ()=> {
  const n = parseInt(wordCountSelect.value);
  selectedWords = pickRandomWords(n===0?fullWordDictionary.length:n);
  currentIndex = 0;
  wordCard.style.display = 'block';
  progressEl.style.display = 'block';
  updateProgress();
  displayCurrent();
  clearFeedback();
  recordingStatus.textContent = recogSupported ? 'SpeechRecognition available ‚Äî STT preferred.' : 'SpeechRecognition not available ‚Äî audio analysis will be used.';
});
nextBtn.addEventListener('click', ()=> {
  if (!selectedWords.length) return;
  currentIndex = (currentIndex + 1) % selectedWords.length;
  updateProgress();
  displayCurrent();
  clearFeedback();
});
listenBtn.addEventListener('click', ()=> {
  const w = selectedWords[currentIndex];
  if (!w) return;
  playTTS(w.english);
});
recordBtn.addEventListener('click', startRecording);
stopBtn.addEventListener('click', stopRecording);
analyzeBtn.addEventListener('click', analyzeRecording);

function displayCurrent(){
  if (!selectedWords.length) return;
  const w = selectedWords[currentIndex];
  targetWordEl.textContent = w.english;
  targetInfoEl.textContent = `Pinyin: ${w.pinyin || '-'} ‚Äî Meaning: ${w.meaning || '-'}`;
  recordingStatus.textContent = 'Click "Start Recording", speak, then "Analyze"';
  recordBtn.disabled = false;
  stopBtn.disabled = true;
  analyzeBtn.disabled = true;
  lastTranscript = "";
  audioChunks = [];
  clearFeedback();
}

/* ---------- Keyboard helper ---------- */
document.addEventListener('keydown', (e)=>{
  if (e.key === ' ' && document.activeElement === recordBtn) { e.preventDefault(); if (!isRecording) startRecording(); else stopRecording(); }
});

/* ---------- Init ---------- */
(function init(){
  recordingStatus.textContent = recogSupported ? 'SpeechRecognition: available (Chromium).' : 'SpeechRecognition: unavailable ‚Äî audio-based fallback (Firefox).';
})();
</script>
</body>
</html>











